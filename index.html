<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>Icy Tower</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#080818;
touch-action:none;user-select:none;-webkit-user-select:none;
-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;
overscroll-behavior:none;position:fixed;top:0;left:0}
canvas{display:block;position:fixed;top:0;left:0;width:100%;height:100%;touch-action:none}
#m{position:fixed;top:10px;right:10px;width:34px;height:34px;
background:rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.25);
border-radius:6px;color:#fff;font:bold 10px monospace;cursor:pointer;
z-index:100;display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<canvas id="c"></canvas>
<button id="m">SND</button>
<script>
'use strict';
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H;
function resize(){W=C.width=innerWidth;H=C.height=innerHeight}
resize();addEventListener('resize',resize);

// ═══ CONSTANTS ═══
const G=0.48, JUMP=-11, SUPERJUMP=-15, ACC=0.55, FRIC=0.89, MAXSPD=7.5;
const PW=22, PH=30, WALLM=18, PLATH=12;
const WALLBOUNCE=0.75;

// ═══ STATE ═══
let st='menu',pl,plats,parts,bgEls,camY,score,hiScore,flr,bestFlr,combo,bestCombo;
let comboT,scrollSpd,gt,shk,shkT,flashA,invT,lastT=0;
let tL=false,tR=false,tJ=false,keys={},muted=false;

// ═══ PERSISTENCE ═══
try{hiScore=+localStorage.icyHS||0}catch(e){hiScore=0}
try{bestFlr=+localStorage.icyBF||0}catch(e){bestFlr=0}
try{bestCombo=+localStorage.icyBC||0}catch(e){bestCombo=0}

// ═══ AUDIO ═══
let ac;
function initA(){if(!ac)ac=new(AudioContext||webkitAudioContext)();if(ac.state==='suspended')ac.resume()}
function snd(t){
  if(muted||!ac)return;
  try{
    const n=ac.currentTime,g=ac.createGain();g.connect(ac.destination);
    if(t==='jump'){
      const o=ac.createOscillator();o.type='square';
      o.frequency.setValueAtTime(300,n);o.frequency.exponentialRampToValueAtTime(600,n+0.08);
      g.gain.setValueAtTime(0.1,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.1);
      o.connect(g);o.start(n);o.stop(n+0.1);
    }else if(t==='land'){
      const o=ac.createOscillator();o.type='triangle';
      o.frequency.setValueAtTime(200,n);o.frequency.exponentialRampToValueAtTime(80,n+0.06);
      g.gain.setValueAtTime(0.08,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.08);
      o.connect(g);o.start(n);o.stop(n+0.08);
    }else if(t==='combo'){
      [440,550,660].forEach((f,i)=>{
        const o=ac.createOscillator(),gg=ac.createGain();
        o.type='square';o.frequency.setValueAtTime(f,n+i*0.06);
        gg.gain.setValueAtTime(0.07,n+i*0.06);gg.gain.exponentialRampToValueAtTime(0.001,n+i*0.06+0.1);
        o.connect(gg);gg.connect(ac.destination);o.start(n+i*0.06);o.stop(n+i*0.06+0.1);
      });
    }else if(t==='die'){
      [300,240,180,120].forEach((f,i)=>{
        const o=ac.createOscillator(),gg=ac.createGain();
        o.type='sawtooth';o.frequency.setValueAtTime(f,n+i*0.1);
        gg.gain.setValueAtTime(0.07,n+i*0.1);gg.gain.exponentialRampToValueAtTime(0.001,n+i*0.1+0.2);
        o.connect(gg);gg.connect(ac.destination);o.start(n+i*0.1);o.stop(n+i*0.1+0.25);
      });
    }else if(t==='wall'){
      const o=ac.createOscillator();o.type='square';
      o.frequency.setValueAtTime(220,n);o.frequency.exponentialRampToValueAtTime(380,n+0.04);
      g.gain.setValueAtTime(0.07,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.06);
      o.connect(g);o.start(n);o.stop(n+0.06);
    }
  }catch(e){}
}
const mb=document.getElementById('m');
mb.onclick=e=>{e.stopPropagation();muted=!muted;mb.textContent=muted?'OFF':'SND'};

// ═══ PARTICLES ═══
function emit(x,y,n,col){
  for(let i=0;i<n;i++)parts.push({
    x:x+(Math.random()-.5)*16, y,
    vx:(Math.random()-.5)*4, vy:-Math.random()*3-1,
    life:1, dec:0.02+Math.random()*0.03,
    sz:2+Math.random()*3, col
  });
}

// ═══ PLATFORM CREATION ═══
// World coords: y=0 at initial ground level, negative = up
function mkPlat(wy,fn){
  const d=Math.min(fn/120,1);
  const minW=Math.max(48,150-d*90), maxW=Math.max(65,200-d*90);
  const w=minW+Math.random()*(maxW-minW);
  const x=WALLM+Math.random()*(W-2*WALLM-w);
  return{x,y:wy,w,h:PLATH,fn,hit:false,cr:Math.random()*w*0.5+w*0.25,ice:Math.random()*0.3+0.1};
}

// ═══ INIT ═══
function init(){
  pl={x:W/2-PW/2, y:-PH, vx:0, vy:0, gnd:false, face:1, jHeld:false};
  plats=[];parts=[];bgEls=[];
  camY=0;score=0;flr=0;combo=0;comboT=0;
  scrollSpd=0.3;gt=0;shk=0;shkT=0;flashA=0.3;invT=1;

  // Ground
  plats.push({x:0,y:0,w:W,h:PLATH,fn:0,hit:true,cr:W/2,ice:0.15});

  // Initial platforms
  let py=0;
  for(let i=1;i<=25;i++){
    const d=Math.min(i/120,1);
    const gap=55+d*35;
    py-=gap;
    flr=i;
    plats.push(mkPlat(py,i));
  }

  // BG elements
  for(let i=0;i<35;i++){
    bgEls.push(mkBg(-Math.random()*5000));
  }
}

function mkBg(wy){
  const r=Math.random();
  if(r<0.35)return{t:'cloud',x:Math.random()*W,y:wy,w:30+Math.random()*50,spd:0.15+Math.random()*0.2,a:0.08+Math.random()*0.12};
  if(r<0.65)return{t:'star',x:Math.random()*W,y:wy,sz:1+Math.random()*2,tw:Math.random()*6.28,a:0.25+Math.random()*0.4};
  return{t:'snow',x:Math.random()*W,y:wy,sz:1+Math.random()*2,spd:0.3+Math.random()*0.4,dr:Math.random()*6.28,a:0.2+Math.random()*0.25};
}

// ═══ SHAKE ═══
function shake(i,d){shkT=d;shk=i}

// ═══ WORLD-TO-SCREEN ═══
function w2s(wy){return wy-camY+H*0.55}

// ═══ UPDATE ═══
function update(dt){
  gt+=dt;
  if(st!=='playing')return;

  scrollSpd=0.3+gt*0.00004;
  if(invT>0)invT-=dt;
  if(comboT>0){comboT-=dt;if(comboT<=0)combo=0}
  if(shkT>0){shkT-=dt}else{shk=0}
  if(flashA>0)flashA-=dt*0.4;

  // ── Movement ──
  const mL=tL||keys.ArrowLeft||keys.a;
  const mR=tR||keys.ArrowRight||keys.d;
  if(mL){pl.vx-=ACC;pl.face=-1}
  if(mR){pl.vx+=ACC;pl.face=1}
  pl.vx*=FRIC;
  if(Math.abs(pl.vx)>MAXSPD)pl.vx=Math.sign(pl.vx)*MAXSPD;
  if(Math.abs(pl.vx)<0.08)pl.vx=0;

  // ── Jump ──
  const wantJ=tJ||keys[' ']||keys.ArrowUp||keys.w;
  if(pl.gnd){
    // Auto-jump or manual jump
    if(wantJ||!pl.jHeld){
      const fast=Math.abs(pl.vx)>4.5;
      pl.vy=fast?SUPERJUMP:JUMP;
      pl.gnd=false;pl.jHeld=true;
      snd('jump');
      if(fast)emit(pl.x+PW/2,pl.y+PH,4,'#ffdd88');
    }
  }
  if(!wantJ)pl.jHeld=false;
  tJ=false;

  // ── Physics ──
  pl.vy+=G;
  pl.x+=pl.vx;
  pl.y+=pl.vy;

  // ── Wall bounce ──
  if(pl.x<WALLM){
    pl.x=WALLM;
    if(Math.abs(pl.vx)>2){
      pl.vx=-pl.vx*WALLBOUNCE;
      if(pl.vy>-2)pl.vy=Math.min(pl.vy,-5);
      pl.face=1;snd('wall');
      emit(pl.x,pl.y+PH/2,3,'#aaddff');shake(3,0.08);
    }else pl.vx=0;
  }
  if(pl.x+PW>W-WALLM){
    pl.x=W-WALLM-PW;
    if(Math.abs(pl.vx)>2){
      pl.vx=-pl.vx*WALLBOUNCE;
      if(pl.vy>-2)pl.vy=Math.min(pl.vy,-5);
      pl.face=-1;snd('wall');
      emit(pl.x+PW,pl.y+PH/2,3,'#aaddff');shake(3,0.08);
    }else pl.vx=0;
  }

  // ── Platform collision ──
  pl.gnd=false;
  if(pl.vy>=0){
    for(const p of plats){
      const top=p.y;
      const prevBot=pl.y+PH-pl.vy;
      const curBot=pl.y+PH;
      if(prevBot<=top && curBot>=top &&
         pl.x+PW>p.x+3 && pl.x<p.x+p.w-3){
        pl.y=top-PH;
        pl.vy=0;
        pl.gnd=true;

        if(!p.hit){
          p.hit=true;
          score+=p.fn*10+combo*5;
          if(comboT>0){
            combo++;
            if(combo%5===0){snd('combo');shake(5,0.12)}
            if(combo>bestCombo)bestCombo=combo;
          }else combo=1;
          comboT=2.5;
          emit(pl.x+PW/2,pl.y+PH,7,'#aaddff');
          snd('land');
        }
        break;
      }
    }
  }

  // ── Camera ──
  const targetCam=pl.y+H*0.1; // keep player at ~45% from top
  const diff=targetCam-camY;
  if(diff<0){
    const spd=Math.abs(diff)>150?0.1:0.05;
    camY+=diff*spd;
  }
  // Forced scroll
  camY-=scrollSpd;

  // ── Generate platforms ──
  let topY=Math.min(...plats.map(p=>p.y));
  const d2=Math.min(flr/120,1);
  const gap=55+d2*35;
  while(topY>camY-H){
    flr++;
    topY-=gap;
    plats.push(mkPlat(topY,flr));
  }

  // ── Cleanup ──
  const botY=camY+H+100;
  plats=plats.filter(p=>p.y<botY);

  // ── Particles ──
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.12;p.life-=p.dec;
    if(p.life<=0)parts.splice(i,1);
  }

  // ── Death check ──
  if(w2s(pl.y)>H+60)die();

  score=Math.max(score,flr*10+combo*5);
}

function die(){
  st='gameover';snd('die');
  if(score>hiScore){hiScore=score;try{localStorage.icyHS=hiScore}catch(e){}}
  if(flr>bestFlr){bestFlr=flr;try{localStorage.icyBF=bestFlr}catch(e){}}
  if(bestCombo>0)try{localStorage.icyBC=bestCombo}catch(e){}
}

// ═══ RENDER ═══
function render(){
  X.save();
  if(shkT>0)X.translate((Math.random()-.5)*shk*2,(Math.random()-.5)*shk*2);

  // ── Background gradient ──
  const hr=Math.min(Math.abs(camY)/12000,1);
  const gd=X.createLinearGradient(0,0,0,H);
  const r1=Math.floor(8+hr*65),g1=Math.floor(8+hr*18),b1=Math.floor(45-hr*15);
  const r2=Math.floor(5+hr*45),g2=Math.floor(5+hr*12),b2=Math.floor(35-hr*10);
  gd.addColorStop(0,`rgb(${r1},${g1},${b1})`);
  gd.addColorStop(1,`rgb(${r2},${g2},${b2})`);
  X.fillStyle=gd;X.fillRect(0,0,W,H);

  // ── BG elements ──
  for(const e of bgEls){
    const sy=w2s(e.y)*0.3+H*0.35; // parallax
    const vy=((sy%H)+H)%H;
    if(e.t==='cloud'){
      X.fillStyle=`rgba(160,185,210,${e.a})`;
      const cx=((e.x+gt*e.spd*20)%(W+e.w*2))-e.w;
      X.beginPath();
      X.arc(cx,vy,e.w*0.28,0,6.28);
      X.arc(cx+e.w*0.22,vy-e.w*0.08,e.w*0.22,0,6.28);
      X.arc(cx+e.w*0.45,vy+e.w*0.02,e.w*0.18,0,6.28);
      X.fill();
    }else if(e.t==='star'){
      const tw=Math.sin(gt*2+e.tw)*0.3+0.7;
      X.fillStyle=`rgba(255,255,230,${e.a*tw})`;
      X.fillRect(e.x,vy,e.sz,e.sz);
    }else{
      const sx=e.x+Math.sin(gt*0.5+e.dr)*12;
      const svy=((vy+gt*e.spd*30)%H+H)%H;
      X.fillStyle=`rgba(210,230,250,${e.a})`;
      X.fillRect(sx,svy,e.sz,e.sz);
    }
  }

  // ── Walls ──
  const wo=camY*0.15;
  X.fillStyle='#1e1e32';
  X.fillRect(0,0,WALLM,H);
  X.fillRect(W-WALLM,0,WALLM,H);
  for(let y=(-wo%18+18)%18;y<H;y+=18){
    X.fillStyle='#191930';
    X.fillRect(0,y,WALLM,1);X.fillRect(W-WALLM,y,WALLM,1);
  }
  // Wall edge highlight
  X.fillStyle='rgba(100,140,180,0.08)';
  X.fillRect(WALLM-1,0,2,H);X.fillRect(W-WALLM-1,0,2,H);

  if(st==='playing'||st==='gameover'){
    // ── Platforms ──
    for(const p of plats){
      const sy=w2s(p.y);
      if(sy>H+20||sy<-20)continue;
      const px=Math.round(p.x);

      // Shadow
      X.fillStyle='rgba(0,0,0,0.15)';
      X.fillRect(px+3,sy+3,p.w,p.h);

      // Main block
      X.fillStyle='#5c6e80';
      X.fillRect(px,sy,p.w,p.h);

      // Top ice
      X.fillStyle='#8cbbd8';
      X.fillRect(px,sy,p.w,3);

      // Sheen
      X.fillStyle=`rgba(190,225,250,${p.ice})`;
      X.fillRect(px+3,sy,p.w*0.35,2);

      // Crack
      X.fillStyle='#4a5a6a';
      X.fillRect(px+p.cr,sy+3,1,p.h-4);
      X.fillRect(px+p.cr,sy+5,5,1);

      // Bottom
      X.fillStyle='#3d4d5d';
      X.fillRect(px,sy+p.h-2,p.w,2);

      // Edges
      X.fillStyle='#7a9aad';
      X.fillRect(px,sy,2,p.h);
      X.fillStyle='#4a5a6a';
      X.fillRect(px+p.w-2,sy,2,p.h);
    }

    // ── Player ──
    const spx=Math.round(pl.x), spy=Math.round(w2s(pl.y));
    if(invT>0&&Math.floor(invT*12)%2===0)X.globalAlpha=0.45;

    // Body
    X.fillStyle='#3080cc';
    X.fillRect(spx+4,spy+10,14,12);

    // Legs
    const lo=pl.gnd?0:(pl.vy<0?-2:2);
    X.fillStyle='#2060a0';
    X.fillRect(spx+5,spy+22,5,7+lo);
    X.fillRect(spx+12,spy+22,5,7-lo);

    // Boots
    X.fillStyle='#4a3322';
    X.fillRect(spx+4,spy+27+lo,6,3);
    X.fillRect(spx+12,spy+27-lo,6,3);

    // Head
    X.fillStyle='#ffcc99';
    X.fillRect(spx+6,spy+2,10,9);

    // Eye
    X.fillStyle='#222';
    X.fillRect(pl.face>0?spx+12:spx+8,spy+5,2,2);

    // Beanie
    X.fillStyle='#d03040';
    X.fillRect(spx+5,spy,12,4);
    X.fillRect(spx+7,spy-2,8,3);
    X.fillStyle='#fff';
    X.fillRect(spx+9,spy-4,4,3);

    // Scarf
    X.fillStyle='#d03040';
    X.fillRect(spx+6,spy+9,10,3);
    X.fillRect(pl.face>0?spx+2:spx+16,spy+10,4,5);

    // Arms
    const aa=pl.gnd?0:(pl.vy<0?-3:2);
    X.fillStyle='#3080cc';
    X.fillRect(spx+1,spy+12+aa,4,7);
    X.fillRect(spx+17,spy+12-aa,4,7);

    // Gloves
    X.fillStyle='#c02030';
    X.fillRect(spx+1,spy+17+aa,4,3);
    X.fillRect(spx+17,spy+17-aa,4,3);

    X.globalAlpha=1;

    // ── Particles ──
    for(const p of parts){
      X.globalAlpha=p.life;
      X.fillStyle=p.col;
      X.fillRect(Math.round(p.x),Math.round(w2s(p.y)),p.sz,p.sz);
    }
    X.globalAlpha=1;

    // Flash
    if(flashA>0){
      X.fillStyle=`rgba(255,255,255,${flashA})`;
      X.fillRect(0,0,W,H);
    }

    // ── HUD ──
    X.fillStyle='#fff';X.font='bold 15px monospace';X.textAlign='left';
    X.fillText('SCORE '+score,10,28);
    X.font='11px monospace';X.fillStyle='#8899aa';
    X.fillText('FLOOR '+flr,10,44);
    X.fillText('BEST  '+hiScore,10,58);

    // Combo
    if(combo>1&&comboT>0){
      const cs=1+Math.sin(gt*8)*0.08;
      const ca=Math.min(comboT/0.5,1);
      X.save();X.globalAlpha=ca;X.textAlign='center';
      X.fillStyle=combo>=10?'#ff4444':combo>=5?'#ff8844':'#ffdd44';
      X.font=`bold ${Math.round(22*cs)}px monospace`;
      X.fillText('x'+combo+' COMBO',W/2,95);
      if(combo>=5){
        X.font=`bold ${Math.round(12*cs)}px monospace`;
        X.fillStyle='#ffeeaa';
        X.fillText(combo>=20?'LEGENDARY!':combo>=15?'INSANE!':combo>=10?'AMAZING!':'GREAT!',W/2,113);
      }
      X.restore();
    }

    // Touch zones
    if(st==='playing'){
      X.globalAlpha=tL?0.1:0.03;X.fillStyle='#fff';
      X.fillRect(0,H*0.5,W/2,H*0.5);
      X.globalAlpha=tR?0.1:0.03;
      X.fillRect(W/2,H*0.5,W/2,H*0.5);
      X.globalAlpha=0.12;X.fillStyle='#fff';X.font='26px monospace';X.textAlign='center';
      X.fillText('<',W*0.12,H*0.88);
      X.fillText('>',W*0.88,H*0.88);
      X.globalAlpha=1;
    }
  }

  // ── MENU ──
  if(st==='menu'){
    X.fillStyle='rgba(4,4,16,0.55)';X.fillRect(0,0,W,H);
    X.textAlign='center';
    const b=Math.sin(gt*2)*4;
    X.fillStyle='#88bbee';X.font='bold 40px monospace';
    X.fillText('ICY',W/2,H*.24+b);
    X.fillStyle='#fff';X.font='bold 46px monospace';
    X.fillText('TOWER',W/2,H*.31+b);
    X.fillStyle='#3388dd';X.fillRect(W/2-55,H*.34,110,3);

    // Pixel snowflakes
    for(let i=0;i<6;i++){
      const a=(i/6)*6.28+gt*.5;
      const r=14+Math.sin(gt*2+i)*3;
      X.fillStyle=`rgba(140,190,240,${0.4+Math.sin(gt+i)*0.3})`;
      X.fillRect(W/2+Math.cos(a)*r-2,H*.19+Math.sin(a)*r+b-2,4,4);
    }

    if(hiScore>0){
      X.fillStyle='#8899aa';X.font='13px monospace';
      X.fillText('HIGH SCORE: '+hiScore,W/2,H*.42);
      X.fillText('BEST FLOOR: '+bestFlr,W/2,H*.46);
    }

    const pu=Math.sin(gt*3)*.3+.7;
    X.globalAlpha=pu;X.fillStyle='#fff';X.font='bold 18px monospace';
    X.fillText('TAP TO START',W/2,H*.58);X.globalAlpha=1;

    X.fillStyle='#556677';X.font='10px monospace';
    X.fillText('LEFT SIDE = MOVE LEFT',W/2,H*.72);
    X.fillText('RIGHT SIDE = MOVE RIGHT',W/2,H*.76);
    X.fillText('AUTO-JUMP ON LANDING',W/2,H*.80);
  }

  // ── GAME OVER ──
  if(st==='gameover'){
    X.fillStyle='rgba(4,4,16,0.7)';X.fillRect(0,0,W,H);
    X.textAlign='center';
    X.fillStyle='#ff5566';X.font='bold 34px monospace';
    X.fillText('GAME OVER',W/2,H*.22);
    X.fillStyle='#3388dd';X.fillRect(W/2-45,H*.25,90,2);
    X.fillStyle='#fff';X.font='bold 20px monospace';
    X.fillText('SCORE: '+score,W/2,H*.34);
    X.fillStyle='#99aabb';X.font='15px monospace';
    X.fillText('FLOOR: '+flr,W/2,H*.41);
    X.fillText('BEST COMBO: x'+bestCombo,W/2,H*.47);

    if(score>=hiScore&&score>0){
      X.globalAlpha=Math.sin(gt*4)*.3+.7;
      X.fillStyle='#ffdd44';X.font='bold 16px monospace';
      X.fillText('*** NEW HIGH SCORE ***',W/2,H*.55);
      X.globalAlpha=1;
    }

    X.fillStyle='#667788';X.font='13px monospace';
    X.fillText('HIGH SCORE: '+hiScore,W/2,H*.62);
    X.fillText('BEST FLOOR: '+bestFlr,W/2,H*.66);

    // Button
    const bw=170,bh=42,bx=W/2-bw/2,by=H*.74+Math.sin(gt*3)*2;
    X.fillStyle='#3080cc';X.fillRect(bx,by,bw,bh);
    X.fillStyle='#50aaee';X.fillRect(bx,by,bw,3);
    X.fillStyle='#2060a0';X.fillRect(bx,by+bh-3,bw,3);
    X.fillStyle='#fff';X.font='bold 15px monospace';
    X.fillText('PLAY AGAIN',W/2,by+bh/2+5);
  }

  X.restore();
}

// ═══ GAME LOOP ═══
function loop(ts){
  const dt=Math.min((ts-lastT)/1000,0.05);lastT=ts;
  update(dt);render();
  requestAnimationFrame(loop);
}

// ═══ INPUT ═══
function startGame(){
  st='playing';init();
}

C.addEventListener('touchstart',e=>{
  e.preventDefault();initA();
  if(st!=='playing'){startGame();return}
  for(const t of e.changedTouches){
    if(t.clientX>W-50&&t.clientY<50)continue;
    if(t.clientX<W/2)tL=true;else tR=true;
    tJ=true;
  }
},{passive:false});

C.addEventListener('touchend',e=>{
  e.preventDefault();tL=tR=false;
  for(let i=0;i<e.touches.length;i++){
    const x=e.touches[i].clientX;
    if(x>W-50&&e.touches[i].clientY<50)continue;
    if(x<W/2)tL=true;else tR=true;
  }
},{passive:false});

C.addEventListener('touchmove',e=>{
  e.preventDefault();tL=tR=false;
  for(let i=0;i<e.touches.length;i++){
    const x=e.touches[i].clientX;
    if(x>W-50&&e.touches[i].clientY<50)continue;
    if(x<W/2)tL=true;else tR=true;
  }
},{passive:false});

C.addEventListener('touchcancel',()=>{tL=tR=false});

C.addEventListener('mousedown',e=>{
  initA();
  if(st!=='playing'){startGame();return}
  if(e.clientX<W/2)tL=true;else tR=true;
  tJ=true;
});
C.addEventListener('mouseup',()=>{tL=tR=false});

document.addEventListener('keydown',e=>{
  keys[e.key]=true;initA();
  if(st!=='playing'&&(e.key===' '||e.key==='Enter'))startGame();
});
document.addEventListener('keyup',e=>{keys[e.key]=false});
document.addEventListener('gesturestart',e=>e.preventDefault());
document.addEventListener('gesturechange',e=>e.preventDefault());

// ═══ START ═══
init();
requestAnimationFrame(loop);
</script>
</body>
</html>
